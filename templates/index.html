<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® åƒè±†äºº</title>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* æµ®åŠ¨åŠ¨ç”» */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* ç»ç’ƒæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* æ¸¸æˆç”»å¸ƒå®¹å™¨ */
        .game-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* æ•°æ®å¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* æŒ‰é’®æ ·å¼ */
        .game-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        /* åˆ†æ•°è·³åŠ¨æ•ˆæœ */
        @keyframes scoreJump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .score-jump {
            animation: scoreJump 0.3s ease;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç²’å­èƒŒæ™¯ */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar {
            transition: width 0.3s ease;
        }

        /* æ ‡ç­¾é¡µ */
        .tab {
            cursor: pointer;
            padding: 12px 24px;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* æ»‘å— */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        /* æˆå°±å¾½ç«  */
        .achievement-badge {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            border-radius: 20px;
            animation: tada 1s ease;
        }

        /* è¿å‡»ç‰¹æ•ˆ */
        @keyframes comboFlash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .combo-flash {
            animation: comboFlash 0.5s ease infinite;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-container {
                max-width: 100%;
            }
        }
    </style>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="bgm" loop preload="auto">
        <source src="https://www.bensound.com/bensound-music/bensound-littleidea.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-eat" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-bomb" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2001/2001-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-powerup" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-achievement" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" type="audio/mpeg">
    </audio>
</head>
<body class="gradient-bg min-h-screen">
    {% raw %}
    <div id="app">
        <!-- ç²’å­èƒŒæ™¯ -->
        <div class="fixed inset-0 overflow-hidden pointer-events-none">
            <div v-for="n in 20" :key="n" class="particle"
                 :style="particleStyle(n)"></div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div class="container mx-auto px-4 py-8 relative z-10">
            <!-- å¤´éƒ¨ -->
            <header class="text-center mb-8 animate__animated animate__fadeInDown">
                <h1 class="text-6xl font-black text-white mb-2 float-animation">
                    <i class="fas fa-ghost mr-3"></i>
                    åƒè±†äºº
                    <i class="fas fa-ghost ml-3"></i>
                </h1>
                <p class="text-white text-xl font-light">
                    Face Tracking Game
                </p>

                <!-- é¡¶éƒ¨æŒ‰é’®ç»„ -->
                <div class="mt-4 flex justify-center gap-4 flex-wrap">
                    <button @click="currentView = 'game'"
                            :class="['px-6 py-2 rounded-full font-semibold transition-all',
                                    currentView === 'game' ? 'bg-white text-purple-600' : 'bg-purple-600 text-white']">
                        <i class="fas fa-gamepad mr-2"></i>æ¸¸æˆ
                    </button>
                    <button @click="currentView = 'settings'"
                            :class="['px-6 py-2 rounded-full font-semibold transition-all',
                                    currentView === 'settings' ? 'bg-white text-purple-600' : 'bg-purple-600 text-white']">
                        <i class="fas fa-cog mr-2"></i>è®¾ç½®
                    </button>
                    <button @click="showLeaderboard = true; loadLeaderboard()"
                            class="px-6 py-2 rounded-full font-semibold bg-yellow-500 text-white hover:bg-yellow-600 transition-all">
                        <i class="fas fa-trophy mr-2"></i>æ’è¡Œæ¦œ
                    </button>
                    <button @click="showAchievements = true"
                            class="px-6 py-2 rounded-full font-semibold bg-green-500 text-white hover:bg-green-600 transition-all">
                        <i class="fas fa-medal mr-2"></i>æˆå°±
                    </button>
                </div>
            </header>

            <!-- çŠ¶æ€æç¤º -->
            <transition name="slide-fade">
                <div v-if="statusMessage.show"
                     :class="['mx-auto max-w-md mb-6 p-4 rounded-xl text-center font-semibold shadow-lg text-white animate__animated animate__bounceIn',
                              statusMessage.type === 'error' ? 'bg-red-500' : statusMessage.type === 'success' ? 'bg-green-500' : 'bg-blue-500']">
                    <i :class="['fas mr-2', statusMessage.type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle']"></i>
                    <span v-html="statusMessage.text"></span>
                </div>
            </transition>

            <!-- æ¸¸æˆè§†å›¾ -->
            <div v-show="currentView === 'game'" class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- å·¦ä¾§ï¼šç»Ÿè®¡é¢æ¿ -->
                    <div class="lg:col-span-1 space-y-4 animate__animated animate__fadeInLeft">
                        <!-- åˆ†æ•°å¡ç‰‡ -->
                        <div class="stat-card rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold opacity-80">
                                    <i class="fas fa-star mr-2 text-yellow-300"></i>
                                    å½“å‰åˆ†æ•°
                                </h3>
                            </div>
                            <div class="text-5xl font-black" :class="{'score-jump': scoreChanged}">
                                {{ gameData.score }}
                            </div>
                            <div class="mt-2 text-sm opacity-70">
                                <span v-if="gameData.score >= 0">ç»§ç»­åŠ æ²¹ï¼</span>
                                <span v-else>å°å¿ƒç‚¸å¼¹ï¼</span>
                            </div>
                        </div>

                        <!-- è¿å‡»å¡ç‰‡ -->
                        <div class="stat-card rounded-2xl p-6 text-white" v-if="gameData.combo > 1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold opacity-80">
                                    <i class="fas fa-fire mr-2 text-orange-400"></i>
                                    è¿å‡»
                                </h3>
                            </div>
                            <div class="text-5xl font-black text-yellow-400 combo-flash">
                                {{ gameData.combo }}x
                            </div>
                            <div class="mt-2 text-sm opacity-70">
                                è¿å‡»è¶Šé«˜ï¼Œåˆ†æ•°è¶Šé«˜ï¼
                            </div>
                        </div>

                        <!-- é“å…·çŠ¶æ€ -->
                        <div class="stat-card rounded-2xl p-6 text-white" v-if="Object.keys(gameData.powerups).length > 0">
                            <h3 class="text-lg font-semibold mb-3">
                                <i class="fas fa-magic mr-2 text-purple-300"></i>
                                æ¿€æ´»é“å…·
                            </h3>
                            <div v-for="(time, type) in gameData.powerups" :key="type" class="mb-2">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold"
                                      :class="getPowerupClass(type)">
                                    {{ getPowerupIcon(type) }} {{ getPowerupName(type) }}: {{ time }}s
                                </span>
                            </div>
                        </div>

                        <!-- æ—¶é—´å¡ç‰‡ -->
                        <div class="stat-card rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold opacity-80">
                                    <i class="fas fa-clock mr-2 text-blue-300"></i>
                                    å‰©ä½™æ—¶é—´
                                </h3>
                            </div>
                            <div class="text-5xl font-black">
                                {{ gameData.timeLeft }}
                                <span class="text-2xl">ç§’</span>
                            </div>
                            <!-- è¿›åº¦æ¡ -->
                            <div class="mt-4 bg-gray-700 rounded-full h-3 overflow-hidden">
                                <div class="progress-bar h-full rounded-full transition-all"
                                     :class="timeBarColor"
                                     :style="{width: timeProgress + '%'}">
                                </div>
                            </div>
                        </div>

                        <!-- æ¸¸æˆè¯´æ˜ -->
                        <div class="stat-card rounded-2xl p-6 text-white">
                            <h3 class="text-lg font-semibold mb-3">
                                <i class="fas fa-info-circle mr-2 text-cyan-300"></i>
                                æ¸¸æˆè¯´æ˜
                            </h3>
                            <ul class="space-y-2 text-sm">
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                                    å¼ å˜´åƒé‡‘å¸ <span class="text-yellow-300 font-bold">+1åˆ†</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-times text-red-400 mr-2 mt-1"></i>
                                    è¯¯åƒç‚¸å¼¹ <span class="text-red-300 font-bold">-5åˆ†</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-magic text-purple-400 mr-2 mt-1"></i>
                                    æ”¶é›†é“å…·è·å¾—å¢ç›Š
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-fire text-orange-400 mr-2 mt-1"></i>
                                    è¿ç»­åƒè±†å­è§¦å‘è¿å‡»
                                </li>
                            </ul>
                        </div>

                        <!-- æœ€ä½³è®°å½• -->
                        <div class="stat-card rounded-2xl p-6 text-white">
                            <h3 class="text-lg font-semibold mb-3">
                                <i class="fas fa-trophy mr-2 text-yellow-400"></i>
                                æœ€ä½³è®°å½•
                            </h3>
                            <div class="text-3xl font-bold text-yellow-300">
                                {{ bestScore }}
                            </div>
                        </div>
                    </div>

                    <!-- ä¸­é—´ï¼šæ¸¸æˆç”»é¢ -->
                    <div class="lg:col-span-2 animate__animated animate__fadeInUp">
                        <div class="game-container">
                            <!-- æ¸¸æˆç”»å¸ƒ -->
                            <div v-if="gameState === 'playing'" class="relative">
                                <img :src="'data:image/jpeg;base64,' + gameFrame"
                                     alt="æ¸¸æˆç”»é¢"
                                     class="w-full h-auto rounded-2xl">

                                <!-- æš‚åœæç¤º -->
                                <div v-if="isPaused" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-2xl">
                                    <div class="text-center text-white">
                                        <i class="fas fa-pause text-8xl mb-4 animate__animated animate__pulse animate__infinite"></i>
                                        <h3 class="text-4xl font-bold">æ¸¸æˆå·²æš‚åœ</h3>
                                        <p class="mt-2">ç‚¹å‡»ç»§ç»­æŒ‰é’®æ¢å¤æ¸¸æˆ</p>
                                    </div>
                                </div>

                                <!-- æ¸¸æˆä¸­çš„æ‚¬æµ®æç¤º -->
                                <div class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-4 py-2 rounded-full text-sm">
                                    <i class="fas fa-video mr-2"></i>
                                    æ‘„åƒå¤´å·²å¯åŠ¨
                                </div>
                            </div>

                            <!-- å¾…æœºç”»é¢ -->
                            <div v-else class="glass rounded-2xl p-12 text-center text-white">
                                <div class="mb-8">
                                    <i class="fas fa-gamepad text-9xl opacity-50 float-animation"></i>
                                </div>
                                <h2 class="text-4xl font-bold mb-4">å‡†å¤‡å¼€å§‹æ¸¸æˆ</h2>
                                <p class="text-lg opacity-80 mb-8">
                                    é€‰æ‹©éš¾åº¦å¹¶ç‚¹å‡»å¼€å§‹æŒ‰é’®
                                </p>

                                <!-- éš¾åº¦é€‰æ‹© -->
                                <div class="mb-8">
                                    <h3 class="text-xl font-semibold mb-4">é€‰æ‹©éš¾åº¦</h3>
                                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                                        <button v-for="(config, key) in difficulties" :key="key"
                                                @click="selectedDifficulty = key"
                                                :class="['p-4 rounded-xl font-bold transition-all',
                                                        selectedDifficulty === key ? 'bg-purple-600 ring-4 ring-yellow-400' : 'bg-purple-700 hover:bg-purple-600']">
                                            <div class="text-2xl mb-2">
                                                {{ getDifficultyIcon(key) }}
                                            </div>
                                            <div>{{ config.name }}</div>
                                        </button>
                                    </div>
                                </div>

                                <!-- æ§åˆ¶æŒ‰é’® -->
                                <div class="flex justify-center gap-4">
                                    <button @click="startGame"
                                            :disabled="isLoading"
                                            class="game-button px-8 py-4 rounded-full text-white font-bold text-lg shadow-xl flex items-center">
                                        <div v-if="isLoading" class="loader mr-3"></div>
                                        <i v-else class="fas fa-play mr-3"></i>
                                        <span v-if="isLoading">å¯åŠ¨ä¸­...</span>
                                        <span v-else>å¼€å§‹æ¸¸æˆ</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- æ¸¸æˆä¸­çš„æ§åˆ¶æŒ‰é’® -->
                        <div v-if="gameState === 'playing'" class="mt-6 flex justify-center gap-4 flex-wrap">
                            <button @click="toggleMusic"
                                    class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-full text-white font-semibold shadow-lg transition-all min-w-[140px]">
                                <i :class="['fas mr-2', isMusicPlaying ? 'fa-volume-up' : 'fa-volume-mute']"></i>
                                {{ isMusicPlaying ? 'éŸ³ä¹å¼€' : 'éŸ³ä¹å…³' }}
                            </button>
                            <button @click="pauseGame"
                                    class="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-full text-white font-semibold shadow-lg transition-all min-w-[140px]">
                                <i :class="['fas mr-2', isPaused ? 'fa-play' : 'fa-pause']"></i>
                                {{ isPaused ? 'ç»§ç»­' : 'æš‚åœ' }}
                            </button>
                            <button @click="stopGame"
                                    class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-full text-white font-semibold shadow-lg transition-all min-w-[140px]">
                                <i class="fas fa-stop mr-2"></i>
                                åœæ­¢æ¸¸æˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®è§†å›¾ -->
            <div v-show="currentView === 'settings'" class="max-w-4xl mx-auto animate__animated animate__fadeIn">
                <div class="glass rounded-3xl p-8 text-white">
                    <h2 class="text-3xl font-bold mb-6">
                        <i class="fas fa-cog mr-3"></i>æ¸¸æˆè®¾ç½®
                    </h2>

                    <div class="space-y-6">
                        <!-- çµæ•åº¦è®¾ç½® -->
                        <div>
                            <label class="block text-lg font-semibold mb-2">
                                <i class="fas fa-sliders-h mr-2"></i>
                                å˜´éƒ¨è¯†åˆ«çµæ•åº¦: {{ (settings.sensitivity * 100).toFixed(0) }}%
                            </label>
                            <input type="range" v-model.number="settings.sensitivity"
                                   min="0.005" max="0.03" step="0.001"
                                   @change="saveSettings">
                            <p class="text-sm opacity-70 mt-1">è°ƒæ•´å˜´éƒ¨å¼ å¼€çš„è¯†åˆ«æ•æ„Ÿåº¦</p>
                        </div>

                        <!-- éŸ³ä¹éŸ³é‡ -->
                        <div>
                            <label class="block text-lg font-semibold mb-2">
                                <i class="fas fa-music mr-2"></i>
                                èƒŒæ™¯éŸ³ä¹éŸ³é‡: {{ (settings.music_volume * 100).toFixed(0) }}%
                            </label>
                            <input type="range" v-model.number="settings.music_volume"
                                   min="0" max="1" step="0.1"
                                   @change="saveSettings">
                        </div>

                        <!-- éŸ³æ•ˆéŸ³é‡ -->
                        <div>
                            <label class="block text-lg font-semibold mb-2">
                                <i class="fas fa-volume-up mr-2"></i>
                                éŸ³æ•ˆéŸ³é‡: {{ (settings.sfx_volume * 100).toFixed(0) }}%
                            </label>
                            <input type="range" v-model.number="settings.sfx_volume"
                                   min="0" max="1" step="0.1"
                                   @change="saveSettings">
                        </div>

                        <!-- ç”»è´¨é€‰æ‹© -->
                        <div>
                            <label class="block text-lg font-semibold mb-2">
                                <i class="fas fa-image mr-2"></i>
                                ç”»è´¨è®¾ç½®
                            </label>
                            <select v-model="settings.quality" @change="saveSettings"
                                    class="w-full p-3 rounded-lg bg-purple-700 text-white font-semibold">
                                <option value="low">æµç•… (ä½ç”»è´¨)</option>
                                <option value="standard">æ ‡å‡† (æ¨è)</option>
                                <option value="high">é«˜æ¸… (é«˜æ€§èƒ½è¦æ±‚)</option>
                            </select>
                        </div>

                        <!-- ä¿å­˜æŒ‰é’® -->
                        <div class="flex justify-end gap-4 mt-8">
                            <button @click="resetSettings"
                                    class="px-6 py-3 rounded-full bg-gray-600 hover:bg-gray-700 text-white font-semibold transition-all">
                                <i class="fas fa-undo mr-2"></i>
                                æ¢å¤é»˜è®¤
                            </button>
                            <button @click="saveSettings"
                                    class="px-6 py-3 rounded-full game-button text-white font-semibold">
                                <i class="fas fa-save mr-2"></i>
                                ä¿å­˜è®¾ç½®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
        <transition name="fade">
            <div v-if="showGameOver"
                 class="fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4"
                 @click.self="closeGameOver">
                <div class="glass rounded-3xl p-8 max-w-md w-full text-white text-center animate__animated animate__zoomIn">
                    <div class="mb-6">
                        <i class="fas fa-flag-checkered text-8xl text-yellow-400 animate__animated animate__tada"></i>
                    </div>

                    <h2 class="text-5xl font-black mb-4">æ¸¸æˆç»“æŸï¼</h2>

                    <div class="bg-black bg-opacity-30 rounded-2xl p-6 mb-6">
                        <div class="text-lg opacity-80 mb-2">æœ€ç»ˆå¾—åˆ†</div>
                        <div class="text-6xl font-black text-yellow-400">{{ finalScore }}</div>

                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="opacity-70">æœ€é«˜è¿å‡»</div>
                                <div class="text-2xl font-bold">{{ gameStats.combo }}</div>
                            </div>
                            <div>
                                <div class="opacity-70">é‡‘å¸æ•°</div>
                                <div class="text-2xl font-bold">{{ gameStats.beans }}</div>
                            </div>
                        </div>

                        <div v-if="isNewRecord" class="mt-4 text-yellow-300 font-semibold animate__animated animate__flash">
                            <i class="fas fa-crown mr-2"></i>
                            æ–°çºªå½•ï¼æ­å–œï¼
                        </div>

                        <!-- è§£é”çš„æˆå°± -->
                        <div v-if="unlockedAchievements.length > 0" class="mt-4">
                            <div class="text-sm opacity-70 mb-2">æœ¬å±€è§£é”æˆå°±</div>
                            <div class="flex flex-wrap justify-center gap-2">
                                <span v-for="ach in unlockedAchievements" :key="ach"
                                      class="achievement-badge text-sm">
                                    {{ getAchievementIcon(ach) }} {{ getAchievementName(ach) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button @click="restartGame"
                                class="flex-1 game-button px-6 py-4 rounded-full text-white font-bold text-lg shadow-xl">
                            <i class="fas fa-redo mr-2"></i>
                            å†ç©ä¸€æ¬¡
                        </button>
                        <button @click="closeGameOver"
                                class="flex-1 bg-gray-600 hover:bg-gray-700 px-6 py-4 rounded-full text-white font-bold text-lg shadow-xl transition-all">
                            <i class="fas fa-times mr-2"></i>
                            å…³é—­
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æ’è¡Œæ¦œæ¨¡æ€æ¡† -->
        <transition name="fade">
            <div v-if="showLeaderboard"
                 class="fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4"
                 @click.self="showLeaderboard = false">
                <div class="glass rounded-3xl p-8 max-w-2xl w-full text-white animate__animated animate__zoomIn">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black">
                            <i class="fas fa-trophy mr-3 text-yellow-400"></i>
                            æ’è¡Œæ¦œ
                        </h2>
                        <button @click="showLeaderboard = false"
                                class="text-white hover:text-gray-300 transition-all">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div v-if="leaderboard.length === 0" class="text-center py-12 opacity-70">
                        <i class="fas fa-inbox text-6xl mb-4"></i>
                        <p class="text-lg">æš‚æ— è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€åå§ï¼</p>
                    </div>

                    <div v-else class="space-y-3 max-h-96 overflow-y-auto">
                        <div v-for="(entry, index) in leaderboard" :key="index"
                             class="bg-black bg-opacity-30 rounded-xl p-4 flex items-center gap-4 hover:bg-opacity-40 transition-all">
                            <!-- æ’å -->
                            <div class="text-3xl font-black w-12 text-center">
                                <span v-if="index === 0" class="text-yellow-400">ğŸ¥‡</span>
                                <span v-else-if="index === 1" class="text-gray-300">ğŸ¥ˆ</span>
                                <span v-else-if="index === 2" class="text-orange-400">ğŸ¥‰</span>
                                <span v-else>{{ index + 1 }}</span>
                            </div>

                            <!-- ä¿¡æ¯ -->
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-2xl font-bold">{{ entry.score }}</span>
                                    <span class="text-sm opacity-70">åˆ†</span>
                                    <span class="px-2 py-1 rounded text-xs font-semibold bg-purple-600">
                                        {{ entry.difficulty }}
                                    </span>
                                </div>
                                <div class="text-sm opacity-70 flex gap-4">
                                    <span>
                                        <i class="fas fa-fire mr-1"></i>
                                        è¿å‡» {{ entry.combo }}
                                    </span>
                                    <span>
                                        <i class="fas fa-coins mr-1"></i>
                                        é‡‘å¸ {{ entry.beans }}
                                    </span>
                                    <span>
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ formatDate(entry.date) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æˆå°±æ¨¡æ€æ¡† -->
        <transition name="fade">
            <div v-if="showAchievements"
                 class="fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4"
                 @click.self="showAchievements = false">
                <div class="glass rounded-3xl p-8 max-w-3xl w-full text-white animate__animated animate__zoomIn">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black">
                            <i class="fas fa-medal mr-3 text-green-400"></i>
                            æˆå°±ç³»ç»Ÿ
                        </h2>
                        <button @click="showAchievements = false"
                                class="text-white hover:text-gray-300 transition-all">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="(achievement, key) in achievements" :key="key"
                             :class="['bg-black bg-opacity-30 rounded-xl p-4 transition-all',
                                     unlockedAchievements.includes(key) ? 'ring-2 ring-yellow-400' : 'opacity-50']">
                            <div class="flex items-start gap-3">
                                <div class="text-4xl">
                                    {{ achievement.icon }}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold mb-1">
                                        {{ achievement.name }}
                                        <i v-if="unlockedAchievements.includes(key)"
                                           class="fas fa-check-circle text-green-400 ml-2"></i>
                                    </h3>
                                    <p class="text-sm opacity-70">{{ achievement.desc }}</p>
                                    <div v-if="unlockedAchievements.includes(key)"
                                         class="mt-2 text-xs text-green-400 font-semibold">
                                        <i class="fas fa-unlock mr-1"></i>å·²è§£é”
                                    </div>
                                    <div v-else class="mt-2 text-xs text-gray-400">
                                        <i class="fas fa-lock mr-1"></i>æœªè§£é”
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <div class="text-lg font-semibold">
                            è¿›åº¦: {{ unlockedAchievements.length }} / {{ Object.keys(achievements).length }}
                        </div>
                        <div class="mt-2 bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-400 to-blue-500 h-full transition-all"
                                 :style="{width: (unlockedAchievements.length / Object.keys(achievements).length * 100) + '%'}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æˆå°±è§£é”é€šçŸ¥ -->
        <transition name="slide-fade">
            <div v-if="achievementNotification.show"
                 class="fixed top-20 right-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl shadow-2xl z-50 animate__animated animate__bounceInRight max-w-sm">
                <div class="flex items-center gap-3">
                    <div class="text-4xl">
                        {{ achievementNotification.icon }}
                    </div>
                    <div>
                        <div class="font-bold text-lg">æˆå°±è§£é”ï¼</div>
                        <div class="text-sm">{{ achievementNotification.name }}</div>
                        <div class="text-xs opacity-80">{{ achievementNotification.desc }}</div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- é“å…·æ”¶é›†é€šçŸ¥ -->
        <transition name="slide-fade">
            <div v-if="powerupNotification.show"
                 class="fixed top-20 left-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-xl shadow-2xl z-50 animate__animated animate__bounceInLeft">
                <div class="flex items-center gap-3">
                    <i class="fas fa-magic text-3xl"></i>
                    <div>
                        <div class="font-bold">é“å…·è·å¾—ï¼</div>
                        <div class="text-sm">{{ powerupNotification.name }}</div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- é¡µè„š -->
        <footer class="text-center text-white mt-12 pb-6 opacity-70">
            <p>
                <i class="fas fa-heart text-red-400 animate__animated animate__heartBeat animate__infinite"></i>
                Made By è’‹æ™Ÿæºï¼Œèƒ¡å®‡ç¿”ï¼Œç‹æŒ¯å®‡ï¼Œå¶é˜³å…‰
                <i class="fas fa-heart text-red-400 animate__animated animate__heartBeat animate__infinite"></i>
            </p>
            <p class="text-sm mt-2">Powered by MediaPipe, Flask & Socket.IO</p>
        </footer>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    audioElements: {
                        bgm: null,
                        eat: null,
                        bomb: null,
                        powerup: null,
                        achievement: null
                    },
                    isMusicPlaying: false,
                    socket: null,
                    currentView: 'game', // game, settings
                    gameState: 'idle', // idle, playing
                    isPaused: false,
                    gameFrame: '',
                    gameData: {
                        score: 0,
                        timeLeft: 30,
                        combo: 0,
                        powerups: {}
                    },
                    gameStats: {
                        combo: 0,
                        beans: 0
                    },
                    showGameOver: false,
                    showLeaderboard: false,
                    showAchievements: false,
                    finalScore: 0,
                    bestScore: localStorage.getItem('bestScore') || 0,
                    isNewRecord: false,
                    statusMessage: {
                        show: false,
                        text: '',
                        type: 'info'
                    },
                    achievementNotification: {
                        show: false,
                        icon: '',
                        name: '',
                        desc: ''
                    },
                    powerupNotification: {
                        show: false,
                        name: ''
                    },
                    isLoading: false,
                    scoreChanged: false,
                    selectedDifficulty: 'normal',
                    difficulties: {},
                    achievements: {},
                    unlockedAchievements: JSON.parse(localStorage.getItem('unlockedAchievements') || '[]'),
                    leaderboard: [],

                    settings: {
                        sensitivity: 0.01,
                        music_volume: 0.5,
                        sfx_volume: 0.7,
                        quality: 'standard'
                    }
                }
            },
            computed: {
                timeProgress() {
                    if (!this.difficulties[this.selectedDifficulty]) return 0;
                    const duration = this.difficulties[this.selectedDifficulty].game_duration || 30;
                    return (this.gameData.timeLeft / duration) * 100;
                },
                timeBarColor() {
                    const progress = this.timeProgress;
                    if (progress > 60) return 'bg-green-500';
                    if (progress > 30) return 'bg-yellow-500';
                    return 'bg-red-500';
                }
            },
            async mounted() {
                this.initSocket();
                this.createParticles();
                await this.loadDifficulties();
                await this.loadAchievements();
                this.loadSettings();
                this.initAudio();
            },
            methods: {
                initSocket() {
                    this.socket = io();

                    this.socket.on('connect', () => {
                        console.log('âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    });

                    this.socket.on('game_started', (data) => {
                        this.gameState = 'playing';
                        this.isPaused = false;
                        this.isLoading = false;
                        this.showStatus(`æ¸¸æˆå·²å¼€å§‹ï¼éš¾åº¦ï¼š${data.difficulty}`, 'success');
                        this.playBGM();
                    });

                    this.socket.on('game_update', (data) => {
                        this.gameFrame = data.frame;

                        // æ£€æµ‹åˆ†æ•°å˜åŒ–ï¼ˆåƒåˆ°è±†å­ï¼‰
                        if (data.score > this.gameData.score) {
                            this.scoreChanged = true;
                            this.playSFX('eat');
                            setTimeout(() => this.scoreChanged = false, 300);
                        }

                        // æ£€æµ‹åˆ†æ•°å‡å°‘ï¼ˆåƒåˆ°ç‚¸å¼¹ï¼‰
                        if (data.score < this.gameData.score) {
                            this.playSFX('bomb');
                        }

                        this.gameData.score = data.score;
                        this.gameData.timeLeft = data.time_left;
                        this.gameData.combo = data.combo;
                        this.gameData.powerups = data.powerups || {};
                    });

                    this.socket.on('game_paused', (data) => {
                        this.isPaused = data.paused;
                    });

                    this.socket.on('game_over', (data) => {
                        this.gameState = 'idle';
                        this.finalScore = data.score;
                        this.gameStats.combo = data.combo;
                        this.gameStats.beans = data.beans;
                        this.showGameOver = true;
                        this.pauseBGM();

                        // æ›´æ–°è§£é”çš„æˆå°±
                        if (data.achievements) {
                            data.achievements.forEach(ach => {
                                if (!this.unlockedAchievements.includes(ach)) {
                                    this.unlockedAchievements.push(ach);
                                }
                            });
                            localStorage.setItem('unlockedAchievements', JSON.stringify(this.unlockedAchievements));
                        }

                        // æ£€æŸ¥æ˜¯å¦åˆ·æ–°è®°å½•
                        if (data.score > this.bestScore) {
                            this.bestScore = data.score;
                            localStorage.setItem('bestScore', data.score);
                            this.isNewRecord = true;
                        } else {
                            this.isNewRecord = false;
                        }
                    });

                    this.socket.on('achievement_unlocked', (data) => {
                        this.showAchievementNotification(data);
                    });

                    this.socket.on('powerup_collected', (data) => {
                        this.showPowerupNotification(data);
                    });

                    this.socket.on('error', (data) => {
                        this.showStatus('é”™è¯¯: ' + data.message, 'error');
                        this.isLoading = false;
                    });

                    this.socket.on('disconnect', () => {
                        console.log('âŒ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                        this.showStatus('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', 'error');
                    });
                },

                initAudio() {
                    this.audioElements.bgm = document.getElementById('bgm');
                    this.audioElements.eat = document.getElementById('sfx-eat');
                    this.audioElements.bomb = document.getElementById('sfx-bomb');
                    this.audioElements.powerup = document.getElementById('sfx-powerup');
                    this.audioElements.achievement = document.getElementById('sfx-achievement');

                    this.updateAudioVolume();
                },

                updateAudioVolume() {
                    if (this.audioElements.bgm) {
                        this.audioElements.bgm.volume = this.settings.music_volume;
                    }
                    Object.keys(this.audioElements).forEach(key => {
                        if (key !== 'bgm' && this.audioElements[key]) {
                            this.audioElements[key].volume = this.settings.sfx_volume;
                        }
                    });
                },

                toggleMusic() {
                    if (this.isMusicPlaying) {
                        this.pauseBGM();
                    } else {
                        this.playBGM();
                    }
                },

                playBGM() {
                    if (this.audioElements.bgm && this.settings.music_volume > 0) {
                        this.audioElements.bgm.play().catch(e => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e));
                        this.isMusicPlaying = true;
                    }
                },

                pauseBGM() {
                    if (this.audioElements.bgm) {
                        this.audioElements.bgm.pause();
                        this.isMusicPlaying = false;
                    }
                },

                playSFX(type) {
                    const audio = this.audioElements[type];
                    if (audio && this.settings.sfx_volume > 0) {
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
                    }
                },

                async loadDifficulties() {
                    try {
                        const response = await fetch('/api/difficulties');
                        this.difficulties = await response.json();
                    } catch (error) {
                        console.error('åŠ è½½éš¾åº¦å¤±è´¥:', error);
                    }
                },

                async loadAchievements() {
                    try {
                        const response = await fetch('/api/achievements');
                        this.achievements = await response.json();
                    } catch (error) {
                        console.error('åŠ è½½æˆå°±å¤±è´¥:', error);
                    }
                },

                loadLeaderboard() {
                    this.socket.emit('get_leaderboard');
                    this.socket.on('leaderboard_data', (data) => {
                        this.leaderboard = data.leaderboard;
                    });
                },

                loadSettings() {
                    const saved = localStorage.getItem('gameSettings');
                    if (saved) {
                        this.settings = JSON.parse(saved);
                    }
                },

                saveSettings() {
                    localStorage.setItem('gameSettings', JSON.stringify(this.settings));
                    this.socket.emit('update_settings', this.settings);
                    this.updateAudioVolume();
                    this.showStatus('è®¾ç½®å·²ä¿å­˜', 'success');
                },

                resetSettings() {
                    this.settings = {
                        sensitivity: 0.01,
                        music_volume: 0.5,
                        sfx_volume: 0.7,
                        quality: 'standard'
                    };
                    this.saveSettings();
                },

                startGame() {
                    this.isLoading = true;
                    this.socket.emit('start_game', { difficulty: this.selectedDifficulty });
                },

                pauseGame() {
                    this.socket.emit('pause_game');
                },

                stopGame() {
                    this.socket.emit('stop_game');
                    this.gameState = 'idle';
                },

                restartGame() {
                    this.showGameOver = false;
                    this.socket.emit('restart_game', { difficulty: this.selectedDifficulty });
                    this.isLoading = true;
                },

                closeGameOver() {
                    this.showGameOver = false;
                },

                showStatus(text, type = 'info') {
                    this.statusMessage = { show: true, text, type };
                    setTimeout(() => {
                        this.statusMessage.show = false;
                    }, 3000);
                },

                showAchievementNotification(data) {
                    this.achievementNotification = {
                        show: true,
                        icon: data.icon,
                        name: data.name,
                        desc: data.desc
                    };
                    setTimeout(() => {
                        this.achievementNotification.show = false;
                    }, 5000);
                },

                showPowerupNotification(data) {
                    this.powerupNotification = {
                        show: true,
                        name: data.name
                    };
                    setTimeout(() => {
                        this.powerupNotification.show = false;
                    }, 3000);
                },

                particleStyle(n) {
                    const size = Math.random() * 10 + 5;
                    const x = Math.random() * 100;
                    const y = Math.random() * 100;
                    const duration = Math.random() * 10 + 5;
                    const delay = Math.random() * 5;

                    return {
                        width: size + 'px',
                        height: size + 'px',
                        left: x + '%',
                        top: y + '%',
                        animation: `float ${duration}s ease-in-out ${delay}s infinite`
                    };
                },

                createParticles() {
                    // ç²’å­å·²é€šè¿‡ v-for åˆ›å»º
                },

                getDifficultyIcon(key) {
                    const icons = {
                        easy: 'ğŸŸ¢',
                        normal: 'ğŸŸ¡',
                        hard: 'ğŸŸ ',
                        hell: 'ğŸ”´'
                    };
                    return icons[key] || 'âšª';
                },

                getPowerupIcon(type) {
                    const icons = {
                        shield: 'ğŸ›¡ï¸',
                        magnet: 'ğŸ§²',
                        slow: 'ğŸŒ',
                        double: 'ğŸ’°'
                    };
                    return icons[type] || 'âœ¨';
                },

                getPowerupName(type) {
                    const names = {
                        shield: 'æŠ¤ç›¾',
                        magnet: 'ç£é“',
                        slow: 'å‡é€Ÿ',
                        double: 'åŒå€'
                    };
                    return names[type] || type;
                },

                getPowerupClass(type) {
                    const classes = {
                        shield: 'bg-cyan-500',
                        magnet: 'bg-purple-500',
                        slow: 'bg-green-500',
                        double: 'bg-yellow-500'
                    };
                    return classes[type] || 'bg-gray-500';
                },

                getAchievementIcon(key) {
                    return this.achievements[key]?.icon || 'ğŸ†';
                },

                getAchievementName(key) {
                    return this.achievements[key]?.name || key;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diff = now - date;
                    const hours = Math.floor(diff / 3600000);

                    if (hours < 1) return 'åˆšåˆš';
                    if (hours < 24) return `${hours}å°æ—¶å‰`;
                    return date.toLocaleDateString('zh-CN');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>